# Contamination in Published Microarray Studies Retrospectively Detected by Deep Learning
In the Microarray study, we retrospectively constructed 37,724 raw microarray images, and developed a deep learning algorithm to automatically detect defects in the original images. Here we provide the identified problematic arrays, affected genes and the imputed arrays as well as software tools to scan for such contamination as a resource to the research community to help future studies to scrutinize and critically analyze these data. 
Please contact (yananq@umich.edu or gyuanfan@umich.edu) if you have any questions or suggestions.
![Figure1](Figure/Fig2.png?raw=true "Title")


## Installation
```
git clone https://github.com/GuanLab/Microarray.git
```

## Required dependencies
* [python](https://www.python.org) (3.7.7)
* [tensorflow](https://www.tensorflow.org/) (1.14.0) A popular deep learning package. It can be installed by:
```
conda install tensorflow-gpu=1.14
```
* [keras](https://keras.io/) (2.2.4) A popular deep learning package using tensorflow backend. It can be installed by:
```
conda install keras-gpu=2.2.4
```
* [opencv-python](https://pypi.org/project/opencv-python/)
```
pip install opencv-python 
```
* [numpy](http://www.numpy.org/)
* [pandas](https://pypi.org/project/pandas/)
* [json](https://docs.python.org/3/library/json.html)
* [os](https://docs.python.org/3/library/os.html)
* [bs4](https://pypi.org/project/bs4/)
* [requests](https://pypi.org/project/requests/2.7.0/)
* [re](https://docs.python.org/3/library/re.html)
* [R](https://www.r-project.org/about.html) (3.6.1)
* [Jupyter Notebook](https://jupyter.org/)
* [Perl](https://www.perl.org/) (5.26.1)


## Dataset
The data can be directly downloaded from [Open Science Framework](https://osf.io/g4qxu/?view_only=3aaf0f0469744e54befbc4f86143ab47):
* recovered v1-v6: contains 1703 recovered samples 
* Contam_genes: contains the list of contaminated genes for every positive sample
* label: human-labelled microarray images
* model: our deep learning model
* HG-U133_Plus_2.cdf: cdf file for HG-U133_Plus_2 platform

## Experiments 
Contact us for training data availability.

### Recovering of microarray images from CEL files
Run the following command:
```
python3 ./reconstruct_to_image/setup.py build
python3 ./reconstruct_to_image/test.py
```

### Create positive labels 
Run the following command:
```
perl ./make_label/Pick.pl
perl ./make_label/Split_processed.pl
python3 ./make_label/label.py
```

### Train 
Open split_5cv.ipynb and run the code inside. This step is to split the data set into 5 folds for the futural five-Fold Cross Validation (CV).
For training, directly run 
```
cd ./train
CUDA_VISIBLE_DEVICES=X bash bash-cv1.sh
CUDA_VISIBLE_DEVICES=X bash bash-cv2.sh
CUDA_VISIBLE_DEVICES=X bash bash-cv3.sh
CUDA_VISIBLE_DEVICES=X bash bash-cv4.sh
CUDA_VISIBLE_DEVICES=X bash bash-cv5.sh
```
Trained model weights for each CV will be saved and used for prediction 
### Prediction
Users can run prediction code using our saved model. 
```
cd ./predict
CUDA_VISIBLE_DEVICES=X python3 pred-cv1.py
CUDA_VISIBLE_DEVICES=X python3 pred-cv2.py
CUDA_VISIBLE_DEVICES=X python3 pred-cv3.py
CUDA_VISIBLE_DEVICES=X python3 pred-cv4.py
CUDA_VISIBLE_DEVICES=X python3 pred-cv5.py
```
Then open dice_index.ipynb to calculate the dice coefficient for each fold of CV

### Expression data in contaminated regions showed less coordinance within probesets
Go to folder 'compare_var', and open gene_expression.ipynb, run the code inside. Then
```
Rscript get_RMA.R
CUDA_VISIBLE_DEVICES=X python3 Var_compare.py
```
Open and run Var_compare.ipynb, you can access the result.

### Literature mining
Run crawl.py using the following command 
```
CUDA_VISIBLE_DEVICES=X python3 ./crawl/crawl.py
```

### Recover Contaminated Probes
```
cd ./recover
```
Run the code in recover.ipynb. Inside the ipynb file, there are some commands asking you run R and python code:
```
Rscript recover.R
CUDA_VISIBLE_DEVICES=X python3 recover_intensity.py 
python3 recover_save_to_map_txt.py
```
Contam_list.ipynb is to give the list of contaminated genes in samples tested as positive



## Vignette -- if you want to test whether your sample has contamination
Have the microarray CEL file in hand and download Github folder 'Example', our deep learning model and HG-U133_Plus_2.cdf from OSF. Move the model weights and cdf file into 'Example'.<br />
Before doing the first step, make sure you have changed the directory in cel_to_img.py. 
First of all, you would need to recover your microarray cel file to an image:
```
python3 setup.py build 
python3 cel_to_img.py
```
The result is a image png file converted from microarray CEL file. 

In the prediction step, we need to use GPU. Run the following command:
```
CUDA_VISIBLE_DEVICES=X python3 Example/pred_example.py
```
This command will have two resulting files:
* result.npy: the prediction result generated by our model
* contam_genes.txt: contains the genes whose probes locat at contaminated area
In order to recover the contaminated region, you should have the original CEL file in hand, and run the following command:
```
Rscript Example/recover_example.R
python3 Example/recover_example.py
```
Then recovered.txt will be the recovered probe intensities.<br />

Here, we give an Example to let you know what are the input and outputs look like. Please check out if you want.

## If you want to use our recovered microarray data
Our recovered data is available to be downloaded from [Open Science Framework](https://osf.io/g4qxu/?view_only=3aaf0f0469744e54befbc4f86143ab47). Note that we recovered 1703 microarray samples with defects. 
* recovered_v1 - v6: contains 1703 recovered samples. The recovered probe expressions of every sample were saved in a TXT file with the same name as CEL file. We save the recoverd value as [probe id: value] pair. 
* contam_genes: contains the list of contaminated genes for every sample with defects (n = 1810)

For example, if your CEL is called XX.CEL, XX.CEL.txt in recovered_vX contains recovered probe expression and XX.CEL.txt in contam_genes contains a list of genes with defects.

## FAQ
* My microarray sample does not appear in the set of 1,810 contaminated samples, does that mean my sample does not have contamination?<br />
Answer: No. We only tested 37,724 microarray samples published before 2019. To get a better result, we encourage you follow our instruction and use our model to test your microarray sample.
* The code does not work. What should I do?<br />
Answer: We recommend that you check all the packages installed and check whether you have changed all the directories in the code. Make sure they are pointing to the right place. If that does not solve your problem, please create a ticket on the [GitHub Issue Tracker](https://github.com/GuanLab/Microarray/issues).
* Can the model work on other platforms other than HG-U133_Plus_2?<br />
Answer: We are working on that. 

